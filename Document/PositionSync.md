# Position Synchronize
对于一个可见物体，改变其位置的因素有两个：
1. 玩家控制位置的输入
2. 来自网络的位置信息

对于玩家控制的主角而言，受到上面两个因素的影响，首先使用输入数据做一个即时的输入，同时输入信息会发送给服务器，服务器做一次位置校验。

对于其他游戏对象的位置由服务器端确定。

##难点
解决网络延迟。

##技术点
1. 服务器对玩家控制的角色的位置信息的处理：
1.1 仅接受键盘输入，并通过玩家的速度信息确定其位置。（难）
：：该难点在与服务器端需要做大量的变换计算。另外涉及碰撞检测，并且需要一个物理引擎，支持游戏的全部计算。
1.2 玩家发送位置信息，服务器检测位置的合理性后反馈一个“同意”的信息


2. 相互作用
如果A玩家撞到了玩家B，如何同步？

如果子弹集中了坦克，如何同步？
：：子弹击中坦克的状态是不可忽略的，如果完全依靠客户端，会出现数据和显示不吻合的现象，如A依据服务器的数据引发了碰撞，但B没有引发碰撞（eg. B的渲染引擎卡住了，这一帧对应的数据没显示出来，结果是B没有碰撞）如果这个碰撞触发了gameover效果，那么会出现A上面显示gameover，但b上面没有。如果同步这个gameover的事件，这时候A发给服务器gameover，但是B没发这个状态（B卡了），这时候再由服务器决定是否触发，所谓的消息验证，进一步如果A,B都卡了，就没有消息发给服务器，那么这个状态就没有。另外，如果A发了击中B的状态，但B卡了，服务器验证后，确定B受伤，这时候A和B都触发了受伤，然后B反应过来（view端），发给服务器B受伤——这时候服务器如何抉择呢？依靠特定业务逻辑判断是否需要受伤？从一个宏观的角度来讲，可以设定一个单向的同步协定，最有利且关系最大的玩家同步数据——击中B对谁最有利？对A了，所以，当B客户端发现自己被A击中时，并不会发送自己受伤的状态。
：：客户端A显示子弹击中了B，但客户端B显示子弹差一点击中B，如何决定？最坏原则——显示击中B
3.实例测试
物体：玩家A控制的坦克tankA，玩家B
场景：tankA向前移动10m
期望：玩家A，B看到tankA向前移动10m，B比A慢
使用（1.1）的实现过程：
*
完美版：客户端发送w按键到服务器，并且tankA在clientA上计算位置，
服务器计算位置返回给所有客户端，返回给客户端计算后的位置和ping值，clientA的客户端会额外做一件事情——根据ping值和服务器返回的位置来决定客户端自身的当前位置是否合理，如果合理，使用客户端的位置，平滑过渡到服务器位置，否则强制将客户端同步到服务器。
：：服务器保存了到该客户端的ping值

简单版：客户端将计算好位置发送到服务器，服务器验证位置是否合理（结合前一次的位置，速度和ping值，合理性验证不能少），之后返回给所有客户端，客户端做一个平滑处理。
：：和完美版相比，客户端没有本地先移动的过程了。

引申：对于dota的位置

轻量级服务器处理：
服务器忽略碰撞检测，只对位置的前进后退做好计算，并反馈给客户端，客户端再根据具体场景做真实处理。有个问题，服务器不知道客户端被挡住了.

使用状态同步——当某一状态太过于频繁时，可以

关于lockstep，可以理解为p2p的帧同步
http://www.zhihu.com/question/36258781

###最后决定，采用状态同步的方式，服务器做好数据合法性检测，而状态同步基于帧同步算法。
####同步什么
有效数据同步：当没有消息，或消息不在范围内时，不同步此类数据。所以对于位置而言，如果B的位置不在A的可视范围内，服务器不发送B的位置到A上，如果B的在A的范围内，但B没有移动，或者B的移动信息未到达服务器，也不发送B的位置到A上——所以A客户端会渲染B是静止的。
- 什么是有效数据：
鼠标点击的位置，按下的键盘键（移动，技能），指令:购买物品，发送的表情，事件：受伤、死亡、加血。

####如何同步
有效数据帧同步：有效数据在每帧后到达，为了确保正确性，服务器给出受伤死亡——如果是锁定攻击方式，服务器仅需要验证玩家是否在合理范围内，并给出有效性的结论即可。如果是非锁定，就要靠服务器端逻辑进行计算该状态是否合理——比如A发送了一个技能是给B加血的，服务器收到后做如下处理：
数据：A释放了加些技能，收集B发送过来的位置信息，如果判定B在加血的条件范围内则同步另外一个数据——B加了多少血。
：：其中有一个重要的概念是，要先处理B发过来的消息，以确保加血是在B移动过后处理的。
：：这就引申出一个概念——一些数据是要依赖当前帧的其他数据。**非输入信息的计算放在输入信息的计算之后**，输入信息包括，键盘，鼠标这些直接的服务设备。
：：另外一类数据是校验数据——对于控制位置的输入信息，会客户端会发送一个位置信息——当然这个位置信息是前一帧的位置信息，以此作为辅助信息使用。
####位置同步是否作为一种特别的数据？
如果位置的输入方式是目的地坐标：发送给各个客户端的也是目标位置。
如果位置的输入方式值前后左右的键盘按键：
：：1.转化成目的地坐标-微量的计算过程
：：2.辅助数据同步-客户端传输上一帧的位置，为服务器提供参考数据
：：考虑到如果只同步wasd，各个客户端可能因小的误差产生蝴蝶效应——永远不知道对方的位置，只是知道相对于现在的位置应该如何移动。那么，这个担心是否是存在呢？如果按照数据强制的帧同步方式考虑：
首先考虑，如果A，B都能正常收到对方输入asdw移动信息，这时候能保证正常处理吗？
：：如果客户端渲染同步一定能保证，如果客户端一方比较卡（如B），就会导致好几帧没有渲染上，B虽然收到了位置信息，但是没有经过客户端的转化，结果就是，在B卡的这段时间里，服务器端发送了3个A的位置变换信息，但B这三个信息都没有处理，实际上其中第二个位置信息触发了另一个效果，如跳到水中。这时候B如何处理呢？普通而言，B等不卡之后会依次执行三个输入——其中一个坑是，对于unity的FixedUpdate，会自动弥补卡顿造成的位置损失，如果这时候再执行三个位置输入就会造成B客户端比A/服务器中实际的位置要远了！如果继续考虑下去，要处理客户端FixedUpdate的问题，就有点超出网络同步的范畴——FixedUpdate本来是优点（解决卡顿问题），结果对于位置同步又成了缺点，所以尽量不要再继续走下去了。另外，如果忽略三次中的前两次呢？不论如何，我都不觉得怎么靠谱了，比如为什么不忽略第三次，有人知道FixedUpdate的模拟会模拟到第三次位置吗？这很容易引起蝴蝶效应。所以对于wasd的输入控制角色移动而言，仅同步wasd的输入时不可行的。
也就是所，如果A，B的网络端没有问题——都没正常接收，但是客户端卡顿会造成位置不同步的问题。更不用说，如果网络不好会怎么样了。

回到之前的想法，如果纯粹的同步角色的位置呢（即，不再接受wasd的输入数据，而是仅接收客户端的位置数据）？先看之前出现的FIxedUpdate的问题，如果B出现了FixedUpdate卡顿，那么在卡顿期间，数据的同步会使用卡顿前的位置，也就是所服务器一直受到客户端没有移动，如果卡顿过后，FixedUpdate发生的位置跳跃被服务器检测是违法数据，那么这次卡顿造成的影响就是客户端引起了无效数据，并回到卡顿之前的位置。从这个角度来讲，方案2.也许能缓冲这个问题，服务器接收wasd同时，参考角色位置，但好处并不多——毕竟是为了填坑，以50步笑百步，还不如直接告诉客户端，你硬件不行，这么难受的玩有啥意思。这里就不再深究了。所以从这个角度看，仅同步位置是可行的。

服务器端只要检验位置是否合法即可，位置的检验参考数据包括，角色之前的位置和速度这两个，以及大致的空间限制。如果角色在y轴（上方）的方向移动了10m就会返回无效——因为在角色当前场景下不可能超过10m。极端考虑，是否服务器需要一个地形系统来判断客户端位置？这样位置移动能够自动的进行。如果是手动检测，客户端可能会发送微量的y轴平移，这时候如果存在攻击判定的能力是依靠Trigger（物理引擎），那么可能这次共计会无效（比如攻击点在脚趾上），从这个角度考虑，除非服务器端存在一个完整的地形系统，否则是没办法在客户端启用Trigger来作为可信的依据。实际上，就算有完整的地形系统处理位置，这也是不可行的，因为Trigger的判断也不能相信客户端，也就是说服务器端需要有一套trigger系统。所以，结论是粗略的位置同步策略，服务器端需要一个粗略的地图来判断客户端的位置是否合理。比如，有些地方的y轴限制是不可预期的。

完美的方案是在服务器端实现一个完整的NoFaceEngine(仅仅没有渲染功能的游戏引擎)。拭目以待吧

那么到此为止，也处理了另外一个疑问——攻击判定信谁？答案是服务器，并且攻击判定的结果是在服务器上进行的，仅仅依靠客户端的帧输入信息，并计算后通知客户端。客户端也要有攻击判定，只是为了显示而已，数据的效果以服务器为准。

网络延迟对位置的影响：
如果B发生了延迟，服务器没有收到B接下来帧同步的3次位置同步（会被服务器忽略掉），但B客户端先执行了位置的变换，等第四次帧同步的时候服务器发现客户端B传输的位置和前一次记录的位置相比是不合法的（因为服务器漏掉了三次位置同步），服务器会通知B的位置在前一次，B收到信息后客户端做出拉回操作（这里的拉回会是瞬时的，因为服务通知的消息类型是无效数据，会当做客户端的异常情况来处理）。这个结果是可以接受的。

关于位置的有效性验证——服务器不能处理碰撞检测，所以如果客户端发送了一个向上的移动或者会引起穿墙的移动，如果验证呢？服务器是否需要一个地图？
答：这个功能要从长计议，目前不考虑复杂的服务器地图，根据需求——如果场景地图过于复杂，可以实现一个服务器地图，如果简单，就实现设定好位置即可。对于《剑侠情缘网络版》而言，游戏中没有高度的概念，我想他们也是考虑了位置的同步吧，游戏中服务器压根没有判断y周（上方）——也不需要，因为同步的数据就没有y方向，如果客户端伪装了y，但只是自己看起来高了而已。
